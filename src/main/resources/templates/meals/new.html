<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org" th:replace="~{layout :: layout}">
<head>
    <title>Add Meal - FitnessApp</title>
</head>
<body>
    <div th:fragment="content">
        <h2 class="mb-4">Add Meal</h2>
        <div class="row">
            <div class="col-md-8">
                <form th:action="@{/meals}" th:object="${meal}" method="post">
                    <input type="hidden" th:name="dailyLogId" th:value="${dailyLogId}">
                    
                    <div class="mb-3">
                        <label for="mealType" class="form-label">Meal Type</label>
                        <select class="form-select" id="mealType" th:field="*{mealType}" required>
                            <option value="">Select meal type...</option>
                            <option value="BREAKFAST">Breakfast</option>
                            <option value="LUNCH">Lunch</option>
                            <option value="DINNER">Dinner</option>
                            <option value="SNACK">Snack</option>
                        </select>
                    </div>

                    <div class="mb-3">
                        <label for="foodId" class="form-label">Food Name</label>
                        <select class="form-select" id="foodId" required>
                            <option value="">Select food...</option>
                        </select>
                        <input type="hidden" id="foodName" th:field="*{foodName}">
                        <small class="form-text text-muted">Select a food from the database</small>
                    </div>

                    <div class="mb-3">
                        <label for="servingSize" class="form-label">Serving Size</label>
                        <input type="text" class="form-control" id="servingSize" th:field="*{servingSize}" 
                               placeholder="e.g., 1 cup, 100g" required>
                    </div>

                    <div class="mb-3">
                        <label for="calories" class="form-label">Calories (optional - will be calculated automatically)</label>
                        <input type="number" class="form-control" id="calories" th:field="*{calories}" min="0">
                    </div>

                    <div class="row">
                        <div class="col-md-4 mb-3">
                            <label for="protein" class="form-label">Protein (g, optional)</label>
                            <input type="number" step="0.1" class="form-control" id="protein" th:field="*{protein}" min="0">
                        </div>
                        <div class="col-md-4 mb-3">
                            <label for="carbs" class="form-label">Carbs (g, optional)</label>
                            <input type="number" step="0.1" class="form-control" id="carbs" th:field="*{carbs}" min="0">
                        </div>
                        <div class="col-md-4 mb-3">
                            <label for="fats" class="form-label">Fats (g, optional)</label>
                            <input type="number" step="0.1" class="form-control" id="fats" th:field="*{fats}" min="0">
                        </div>
                    </div>

                    <div class="d-flex gap-2">
                        <button type="submit" class="btn btn-primary">Add Meal</button>
                        <a th:href="@{'/logs/' + ${date}}" class="btn btn-secondary">Cancel</a>
                    </div>
                </form>
            </div>
        </div>
    </div>
    <div th:fragment="scripts">
        <script>
            document.addEventListener('DOMContentLoaded', function() {
                const foodIdSelect = document.getElementById('foodId');
                const foodNameInput = document.getElementById('foodName');
                const servingSizeInput = document.getElementById('servingSize');
                const caloriesInput = document.getElementById('calories');
                const proteinInput = document.getElementById('protein');
                const carbsInput = document.getElementById('carbs');
                const fatsInput = document.getElementById('fats');
                
                let selectedFoodName = null;
                let isLoading = false;

                loadFoodsIntoDropdown();

                const form = document.querySelector('form');
                if (form) {
                    form.addEventListener('submit', function(e) {
                        if (!foodNameInput.value || foodNameInput.value.trim() === '') {
                            const selectedOption = foodIdSelect.options[foodIdSelect.selectedIndex];
                            if (selectedOption && selectedOption.value) {
                                const foodName = selectedOption.getAttribute('data-food-name');
                                if (foodName) {
                                    foodNameInput.value = foodName;
                                }
                            }
                        }
                    });
                }

                function loadFoodsIntoDropdown() {
                    if (isLoading) return;
                    isLoading = true;
                    
                    while (foodIdSelect.options.length > 1) {
                        foodIdSelect.remove(1);
                    }
                    
                    const loadingOption = document.createElement('option');
                    loadingOption.value = '';
                    loadingOption.textContent = 'Loading foods...';
                    foodIdSelect.appendChild(loadingOption);
                    
                    fetch('/api/foods/all', {
                        credentials: 'include'
                    })
                        .then(response => {
                            if (!response.ok) {
                                throw new Error('Failed to load foods');
                            }
                            return response.json();
                        })
                        .then(foods => {
                            foodIdSelect.remove(foodIdSelect.options.length - 1);
                            
                            if (foods && foods.length > 0) {
                                foods.sort((a, b) => a.name.localeCompare(b.name));
                                
                                foods.forEach(food => {
                                    const option = document.createElement('option');
                                    option.value = food.id;
                                    option.textContent = food.name + ' (' + food.servingSize + ')';
                                    option.setAttribute('data-serving-size', food.servingSize);
                                    option.setAttribute('data-food-name', food.name);
                                    foodIdSelect.appendChild(option);
                                });
                            } else {
                                const option = document.createElement('option');
                                option.value = '';
                                option.textContent = 'No foods available';
                                foodIdSelect.appendChild(option);
                            }
                            isLoading = false;
                        })
                        .catch(error => {
                            foodIdSelect.remove(foodIdSelect.options.length - 1);
                            const option = document.createElement('option');
                            option.value = '';
                            option.textContent = 'Error loading foods - please refresh';
                            foodIdSelect.appendChild(option);
                            isLoading = false;
                        });
                }

                foodIdSelect.addEventListener('change', function() {
                    const selectedOption = this.options[this.selectedIndex];
                    const foodId = this.value;
                    
                    if (!foodId) {
                        foodNameInput.value = '';
                        servingSizeInput.value = '';
                        caloriesInput.value = '';
                        proteinInput.value = '';
                        carbsInput.value = '';
                        fatsInput.value = '';
                        selectedFoodName = null;
                        return;
                    }

                    const foodName = selectedOption.getAttribute('data-food-name');
                    const defaultServingSize = selectedOption.getAttribute('data-serving-size');
                    
                    selectedFoodName = foodName;
                    foodNameInput.value = foodName;
                    servingSizeInput.value = defaultServingSize || '1 serving';

                    const servingSize = servingSizeInput.value;
                    
                    fetch('/api/foods/calc', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json'
                        },
                        credentials: 'include',
                        body: JSON.stringify({
                            foodName: foodName,
                            servingSize: servingSize,
                            portions: 1.0
                        })
                    })
                    .then(response => {
                        if (!response.ok) {
                            throw new Error('Failed to calculate calories');
                        }
                        return response.json();
                    })
                    .then(calculation => {
                        if (calculation) {
                            caloriesInput.value = calculation.calories || '';
                            proteinInput.value = calculation.protein || '';
                            carbsInput.value = calculation.carbs || '';
                            fatsInput.value = calculation.fats || '';
                        }
                    })
                    .catch(error => {
                        caloriesInput.value = '';
                        proteinInput.value = '';
                        carbsInput.value = '';
                        fatsInput.value = '';
                    });
                });

                servingSizeInput.addEventListener('change', function() {
                    if (selectedFoodName && this.value) {
                        const servingSize = this.value;
                        
                        fetch('/api/foods/calc', {
                            method: 'POST',
                            headers: {
                                'Content-Type': 'application/json'
                            },
                            credentials: 'include',
                            body: JSON.stringify({
                                foodName: selectedFoodName,
                                servingSize: servingSize,
                                portions: 1.0
                            })
                        })
                        .then(response => {
                            if (!response.ok) {
                                throw new Error('Failed to calculate calories');
                            }
                            return response.json();
                        })
                        .then(calculation => {
                            if (calculation) {
                                caloriesInput.value = calculation.calories || '';
                                proteinInput.value = calculation.protein || '';
                                carbsInput.value = calculation.carbs || '';
                                fatsInput.value = calculation.fats || '';
                            }
                        })
                        .catch(error => {
                            caloriesInput.value = '';
                            proteinInput.value = '';
                            carbsInput.value = '';
                            fatsInput.value = '';
                        });
                    }
                });
            });
        </script>
    </div>
</body>
</html>

